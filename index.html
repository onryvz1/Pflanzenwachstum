<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Was brauchen Pflanzen zum Wachsen?</title>
<style>
  :root{
    --panel:#0f1a2f;
    --card:#132241;
    --earth:#6b4b2f;
    --earth2:#8a6442;
    --text:#e8eef9;
    --root:#2b1a0f;  /* dunkles Braun f√ºr Wurzel */
    --o2:#9fd9ff;
    --sugar:#ffffff;
    --water:#0b5bd3;
    --co2:#9aa0a8;
    --light:#ffd84d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1320;color:var(--text)}
  .wrap{display:grid;grid-template-columns: 380px 1fr; gap:16px; padding:16px; height:100%}
  @media (max-width: 900px){ .wrap{grid-template-columns:1fr; grid-template-rows:auto 1fr} }
  .panel{background:var(--panel); border:1px solid #1f2c49; border-radius:14px; padding:16px}
  h1{font-size:20px;margin:0 0 8px 0}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px}
  .btn{cursor:pointer; border:1px solid #34507f; background:#163058; color:#dce7fb;
       padding:10px 12px; border-radius:12px; font-size:14px; min-width:120px; text-align:center}
  .btn.active{background:#164e2f; border-color:#2e7a4f}
  .btn.warn{border-color:#7f3444; background:#4a1e24}
  .btn.primary{border-color:#2e7a4f; background:#165033}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid #223457; padding:10px; border-radius:12px; margin-top:10px}
  .kv{display:flex; justify-content:space-between; gap:12px; font-variant-numeric:tabular-nums; align-items:center}
  .big{font-size:18px}
  .canvas{position:relative; height:100%; min-height:600px; background:#081630; border-radius:16px; border:1px solid #1b2b4a; overflow:hidden}
  .bgRef{position:absolute; inset:0;}

  .overlay{position:absolute; inset:0; pointer-events:none; z-index:15}

  /* Sun/Moon */
  .skyIcon{position:absolute; top:10px; left:10px; width:64px; height:64px; border-radius:50%; display:none; z-index:16}
  .sun{background:radial-gradient(circle at 35% 35%, #fff9c2, var(--light)); box-shadow:0 0 60px rgba(255,216,77,.45)}
  .moon{background:radial-gradient(circle at 40% 35%, #e8ecf5, #b7c2d9); box-shadow:0 0 30px rgba(180,190,210,.25)}
  .ray{position:absolute; height:2px; background:linear-gradient(90deg, var(--light), transparent); transform-origin:left center; opacity:0.9}

  /* Particles */
  .co2Dot{position:absolute; width:12px; height:12px; border-radius:50%; background:var(--co2); opacity:.98; box-shadow:0 0 8px rgba(160,160,170,.7)}
  .co2Fade{transition:opacity .4s ease}
  .o2{position:absolute; width:13px; height:13px; border-radius:50%; background:var(--o2); box-shadow:0 0 10px rgba(160,210,255,1); opacity:0}
  @keyframes o2Out{0%{opacity:0; transform:translate(0,0)} 25%{opacity:1} 100%{opacity:0; transform:translate(var(--dx,0), var(--dy,-80px))}}
  .sugar{position:absolute; width:9px; height:9px; border-radius:50%; background:var(--sugar); box-shadow:0 0 12px rgba(255,255,255,.95); opacity:0}

  /* Water on soil surface */
  .waterDrop{position:absolute; width:14px; height:14px; border-radius:50%; background:var(--water); box-shadow:0 0 14px rgba(30,90,190,1); opacity:.98}
  @keyframes waterFlowSurface{0%{transform:translateX(var(--fromX,0)); opacity:1} 100%{transform:translateX(var(--toX,0)); opacity:.55}}

  /* Sugar internal animations */
  @keyframes sugarLeafJitter{0%{opacity:0; transform:translate(0,0)} 20%{opacity:1} 100%{opacity:1; transform:translate(var(--dxLeaf,0), var(--dyLeaf,0))}}
  @keyframes sugarIntoStem{0%{opacity:0; transform:translate(0,0)} 20%{opacity:1} 100%{opacity:1; transform:translate(var(--dxStem,0), var(--dyStem,0))}}
  @keyframes sugarDownStem{0%{opacity:1; transform:translate(0,0)} 100%{opacity:1; transform:translate(0, var(--dyDown, 60px))}}

  /* Ground */
  .earth{position:absolute; left:0; right:0; bottom:0; height:220px; background:linear-gradient(180deg,var(--earth),var(--earth2)); border-top:2px solid #3c2b1a; z-index:1}
  .soilLine{position:absolute; left:0; right:0; bottom:220px; height:2px; background:#5d4128; opacity:.98; z-index:6}

  /* Plant */
  .plant{position:absolute; left:50%; bottom:220px; width:240px; height:340px; transform-origin:50% 100%; transform:translateX(-50%) scale(.35); z-index:7}
  .stem{position:absolute; left:50%; bottom:0; transform:translateX(-50%) rotate(180deg); width:22px; height:240px; background:linear-gradient(180deg,#8b5a2b,#5c3d1e); border-radius:16px}

  /* Growing root (under soil): main + two branches */
  .rootWrap{position:absolute; left:50%; bottom:-12px; transform:translateX(-50%) rotate(180deg); width:0; height:0; z-index:5; pointer-events:none;}
  .rootMain, .rootLeft, .rootRight{position:absolute; bottom:0; width:6px; background:var(--root); border-radius:3px; box-shadow:0 0 6px rgba(20,10,0,.35)}
  .rootMain{left:-3px; height:28px;}         /* start small */
  .rootLeft{left:-3px; height:20px; transform-origin:bottom center; transform:rotate(-22deg);}
  .rootRight{left:-3px; height:20px; transform-origin:bottom center; transform:rotate(22deg);}

  /* Leaves */
  .leaf{position:absolute; background:radial-gradient(28px 18px at 20% 50%, #3ed978, #1e8e49); border-radius:40px/26px; transform-origin:0% 50%; filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
  .leaf.left{top:120px; left: calc(50% - 13px); transform:rotate(-12deg)}
  .leaf.right{top:120px; left: calc(50% + 11px); transform:rotate(12deg)}

  /* Legend */
  .legendItem{border:1px solid #29466e; padding:6px 10px; border-radius:10px; background:#132241; color:#e6f0ff}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Was brauchen Pflanzen zum Wachsen?</h1>

    <div class="controls">
      <button id="start" class="btn primary">‚ñ∂Ô∏è Start</button>
      <button id="pause" class="btn" disabled>‚è∏Ô∏è Pause</button>
      <button id="reset" class="btn warn" disabled>Neu starten</button>
    </div>

    <div class="row">
      <button id="btnLight" class="btn" disabled>‚òÄÔ∏è Licht: <b>aus</b></button>
      <button id="btnWater" class="btn" disabled>üíß Wasser: <b>aus</b></button>
      <button id="btnCO2"   class="btn" disabled>üå¨Ô∏è Kohlenstoffdioxid: <b>aus</b></button>
    </div>
    <div class="card">
      <div class="kv"><span>Zeit</span><span id="timeLabel">0,00 Jahre (0:00)</span></div>
    </div>
    <div class="card">
      <div class="kv big"><span>Gewicht der Pflanze</span><span id="plantMassLabel">0,20 kg</span></div>
    </div>

  </div>

  <div class="panel canvas" id="stage">
    <div class="bgRef" aria-hidden="true"></div>

    <div style="position:absolute; right:12px; top:12px; display:flex; gap:8px; flex-wrap:wrap; z-index:20">
      <div class="legendItem"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--water);margin-right:6px;vertical-align:middle"></span>Wasser</div>
      <div class="legendItem"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--light);margin-right:6px;vertical-align:middle"></span>Licht</div>
      <div class="legendItem"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--co2);margin-right:6px;vertical-align:middle"></span>Kohlenstoffdioxid</div>
      <div class="legendItem"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--o2);margin-right:6px;vertical-align:middle"></span>Sauerstoff</div>
      <div class="legendItem"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--sugar);margin-right:6px;vertical-align:middle"></span>Glukose</div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="pauseNotice" style="position:absolute; left:50%; top:40%; transform:translateX(-50%); background:rgba(120,120,120,0.6); color:#fff; padding:12px 20px; border-radius:10px; font-weight:700; font-size:22px; display:none; z-index:40">Pause</div>
    <div id="endNotice" style="position:absolute; left:50%; top:18%; transform:translateX(-50%); background:rgba(0,0,0,0.55); color:#fff; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.25); font-weight:600; display:none; z-index:30">Die Versuchszeit ist zu Ende. Starte den Versuch neu.</div>
    <div id="skyIcon" class="skyIcon sun"></div>

    <div class="plant" id="plant">
      <div class="stem" id="stem"></div>
      <div class="leaf left"  data-side="left"></div>
      <div class="leaf right" data-side="right"></div>
      <!-- Root under soil, attached at stem base -->
      <div class="rootWrap" id="rootWrap">
        <div class="rootMain" id="rootMain"></div>
        <div class="rootLeft" id="rootLeft"></div>
        <div class="rootRight" id="rootRight"></div>
      </div>
    </div>

    <div class="soilLine"></div>
    <div class="earth"></div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const startBtn=$('#start'), pauseBtn=$('#pause'), resetBtn=$('#reset');
  const btnLight=$('#btnLight'), btnWater=$('#btnWater'), btnCO2=$('#btnCO2');
  const timeLabel=$('#timeLabel'), plantMassLabel=$('#plantMassLabel');

  const stage=$('#stage'), overlay=$('#overlay'), plant=$('#plant'), skyIcon=$('#skyIcon');
  const rootWrap=$('#rootWrap'), rootMain=$('#rootMain'), rootLeft=$('#rootLeft'), rootRight=$('#rootRight');

  const START_PLANT=0.2, END_PLANT=8.0, START_SOIL=10.0, END_SOIL_MIN=9.9, YEARS=5;
  const YEARS_TOTAL_SECONDS=180, YEARS_PER_SECOND=YEARS/YEARS_TOTAL_SECONDS;
  const IDEAL_GROWTH_PER_YEAR=(END_PLANT-START_PLANT)/YEARS;const PARTICLE_INTERVAL_MS=1050;
  const ROOT_MAX=200; // px
  const ROOT_BASE=28; // initial main length

  let tYears=0, plantKg=START_PLANT;
  let onLight=false, onWater=false, onCO2=false;
  let running=false, finished=false, paused=false;
  let rafLast=0, particleTimer=null, waterTimer=null, co2Timer=null;
  let leafGrowth=0;

  function productionActive(){ return running && !finished && !paused && onLight && onWater && onCO2; }
  function kg(v){ return v>=1 ? v.toFixed(2).replace('.',',')+' kg' : (v*1000).toFixed(0)+' g'; }
  function mmss(s){ s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), sec=s%60; return m+':'+(sec<10?'0':'')+sec; }
  function setBtn(btn,on){ btn.classList.toggle('active',on); const label=btn.textContent.split(':')[0]; btn.innerHTML=label+': <b>'+(on?'an':'aus')+'</b>'; }
  function enableResourceButtons(e){ [btnLight,btnWater,btnCO2].forEach(b=>b.disabled=!e); }

  function sizeLeafs(){
    const baseW=40, baseH=20, maxW=140, maxH=70;
    const w = baseW + (maxW-baseW)*leafGrowth;
    const h = baseH + (maxH-baseH)*leafGrowth;
    $$('.leaf').forEach(leaf=>{ leaf.style.width=w+'px'; leaf.style.height=h+'px'; });
  }

  function updateRoot(){
    // growth progress of plant 0..1
    const p = Math.min(1, Math.max(0, (plantKg-START_PLANT)/(END_PLANT-START_PLANT)));
    // root grows slower: 70% of plant progress
    const rp = Math.min(1, 0.7 * p);
    // main length between base and ROOT_MAX
    const L = Math.min(ROOT_MAX, ROOT_BASE + rp * (ROOT_MAX - ROOT_BASE));
    // branches length proportionally shorter
    const Lb = Math.max(16, Math.min(L*0.7, ROOT_MAX*0.7));
    rootMain.style.height = L + 'px';
    rootLeft.style.height = Lb + 'px';
    rootRight.style.height = Lb + 'px';
    // opening angle widens with rp
    const angBase = 18, angMax = 40;
    const ang = angBase + (angMax - angBase) * rp;
    rootLeft.style.transform = 'rotate(' + (-ang) + 'deg)';
    rootRight.style.transform = 'rotate(' + (ang) + 'deg)';
    // push whole rootWrap slightly deeper as it grows to avoid "floating" near soil line
    const extraDown = Math.round(rp * 14); // up to 8px deeper
    rootWrap.style.bottom = (-6 - extraDown) + 'px';
  }

  function updateUI(){
    timeLabel.textContent = tYears.toFixed(2).replace('.',',')+' Jahre ('+mmss(tYears/YEARS_PER_SECOND)+')';
    plantMassLabel.textContent = kg(plantKg);const scale=0.35+(plantKg/END_PLANT)*0.9;
    plant.style.transform='translateX(-50%) scale('+scale+')';
    sizeLeafs();
    updateRoot();
    drawRays();
  }

  // SUN/MOON + rays
  function setLight(on){
    skyIcon.style.display='block'; skyIcon.className='skyIcon ' + (on?'sun':'moon');
    if(!on){ overlay.querySelectorAll('.ray').forEach(r=>r.remove()); } else { drawRays(); }
  }
  function drawRays(){
    overlay.querySelectorAll('.ray').forEach(r=>r.remove());
    if(!onLight) return;
    const stageR=stage.getBoundingClientRect();
    const sunR=skyIcon.getBoundingClientRect();
    const sunCx=sunR.left - stageR.left + sunR.width/2;
    const sunCy=sunR.top  - stageR.top  + sunR.height/2;
    $$('.leaf').forEach(leaf=>{
      const lr=leaf.getBoundingClientRect();
      const tx=(lr.left - stageR.left)+(leaf.classList.contains('left')? 6 : lr.width-6);
      const ty=(lr.top  - stageR.top )+ lr.height*0.45;
      const dx=tx - sunCx, dy=ty - sunCy;
      const len=Math.hypot(dx,dy), ang=Math.atan2(dy,dx)*180/Math.PI;
      const r=document.createElement('div');
      r.className='ray';
      r.style.left=sunCx+'px'; r.style.top=sunCy+'px'; r.style.width=len+'px'; r.style.transform='rotate('+ang+'deg)';
      overlay.appendChild(r);
    });
  }

  // WATER on soil: spawn immediately and then at interval while ON
  function spawnWaterOnce(){
    const d=document.createElement('div'); d.className='waterDrop';
    const sx=(Math.random()*340 - 170);
    const toCenter = -sx * 0.95;
    d.style.left='calc(50% + '+sx+'px)';
    d.style.bottom= (220-6) + 'px';
    d.style.setProperty('--fromX','0px');
    d.style.setProperty('--toX', toCenter+'px');
    d.style.animation='waterFlowSurface 3.5s linear forwards';
    overlay.appendChild(d);
    d.addEventListener('animationend', ()=>d.remove());
}
  function startWater(){
    if(waterTimer) return;
    spawnWaterOnce(); // immediate visual
    waterTimer=setInterval(()=>{ if(onWater && running && !finished && !paused){ spawnWaterOnce(); } }, 1400);
}
  function stopWater(){ if(waterTimer){ clearInterval(waterTimer); waterTimer=null; } }

  // CO2: spawn immediately and at interval while ON; motion pauses when global pause is active
  function spawnCO2Once(){
    const leaves=$$('.leaf'); if(leaves.length===0) return;
    const stageR=stage.getBoundingClientRect();
    const soilTop = stageR.height - 220;
    const pr=plant.getBoundingClientRect();
    const cx=pr.left - stageR.left + pr.width/2;
    const cy=pr.top  - stageR.top  + pr.height/2;
    let sx, sy;
    for(let tries=0; tries<10; tries++){
      const ang=Math.random()*Math.PI*2, rad=180+Math.random()*40;
      sx=cx + Math.cos(ang)*rad;
      sy=cy + Math.sin(ang)*rad;
      if (sy < soilTop - 10) break;
    }
    if (sy >= soilTop - 10) sy = soilTop - (20 + Math.random()*40);
    const leafEl = leaves[Math.floor(Math.random()*leaves.length)];
    const lr=leafEl.getBoundingClientRect();
    const tx=(lr.left - stageR.left)+lr.width/2;
    const ty=(lr.top  - stageR.top )+lr.height/2;

    const dot=document.createElement('div'); dot.className='co2Dot co2Fade';
    dot.style.left=sx+'px'; dot.style.top=sy+'px'; dot.style.opacity='1';
    overlay.appendChild(dot);
    const dur=1800+Math.random()*800;
    let start=null;
    function move(ts){
      if(!start) start=ts;
      if(!onCO2 || finished){ dot.style.opacity='0'; setTimeout(()=>dot.remove(), 400); return; }
      if(paused || !running){ requestAnimationFrame(move); return; }
      const elapsed=ts-start;
      const p=Math.min(1, elapsed/dur);
      const ex=sx+(tx-sx)*p, ey=sy+(ty-sy)*p;
      dot.style.left=ex+'px'; dot.style.top=ey+'px'; dot.style.opacity=(1-p*0.9);
      if(p<1){ requestAnimationFrame(move); } else { dot.remove(); }
    }
    requestAnimationFrame(move);
  }
  function startCO2(){
    if(co2Timer) return;
    spawnCO2Once(); // immediate visual
    co2Timer=setInterval(()=>{ if(onCO2 && running && !finished && !paused){ spawnCO2Once(); } }, 950);
}
  function stopCO2(){ if(co2Timer){ clearInterval(co2Timer); co2Timer=null; } }

  function setAnimationsPaused(isPaused){
  const els = Array.from(overlay.querySelectorAll('.waterDrop, .o2, .sugar, .ray'));
  els.forEach(el=>{ el.style.animationPlayState = isPaused ? 'paused' : 'running'; });
}

// O2 from leaves + Sugar within leaves or into stem (internal)
  function spawnO2FromLeaf(leaf){
    const stageR=stage.getBoundingClientRect();
    const lr=leaf.getBoundingClientRect();
    const x=(lr.left - stageR.left) + (leaf.classList.contains('left')? 6 : lr.width-6);
    const y=(lr.top  - stageR.top ) + lr.height*0.45;
    const p=document.createElement('div'); p.className='o2';
    p.style.left=x+'px'; p.style.top=y+'px';
    const dx=(leaf.classList.contains('left')?-1:1)*(40+Math.random()*40);
    const dy=-(80+Math.random()*40);
    p.style.setProperty('--dx',dx+'px'); p.style.setProperty('--dy',dy+'px');
    p.style.animation='o2Out 2.4s linear forwards';
    overlay.appendChild(p);
    p.addEventListener('animationend', ()=>{ if(!paused) p.remove(); });
  }

  function spawnSugar(leaf){
    const stageR=stage.getBoundingClientRect();
    const lr=leaf.getBoundingClientRect();
    const pr=plant.getBoundingClientRect();
    const inLeaf = Math.random() < 0.7; // 70% jitter inside leaf

    if(inLeaf){
      const startX=(lr.left - stageR.left) + lr.width*(0.45+Math.random()*0.1);
      const startY=(lr.top  - stageR.top ) + lr.height*(0.45+Math.random()*0.1);
      const dx=(Math.random()*20-10), dy=(Math.random()*12-6);
      const p=document.createElement('div'); p.className='sugar';
      p.style.left=startX+'px'; p.style.top=startY+'px';
      p.style.setProperty('--dxLeaf', dx+'px');
      p.style.setProperty('--dyLeaf', dy+'px');
      p.style.animation='sugarLeafJitter 1.2s ease-out forwards';
      overlay.appendChild(p);
      p.addEventListener('animationend', ()=>{ if(!paused) p.remove(); });
    } else {
      // leaf base -> stem edge -> then ALWAYS downwards inside stem
      const baseX=(lr.left - stageR.left) + (leaf.classList.contains('left')? 6 : lr.width-6);
      const baseY=(lr.top  - stageR.top ) + lr.height*0.5;
      const stemX=(pr.left - stageR.left)+pr.width/2;
      const stemY=baseY;
      const p1=document.createElement('div'); p1.className='sugar';
      p1.style.left=baseX+'px'; p1.style.top=baseY+'px';
      p1.style.setProperty('--dxStem', (stemX-baseX)+'px');
      p1.style.setProperty('--dyStem', (stemY-baseY)+'px');
      p1.style.animation='sugarIntoStem 0.5s linear forwards';
      overlay.appendChild(p1);
      setTimeout(()=>{
        p1.remove();
        const p2=document.createElement('div'); p2.className='sugar';
        p2.style.left=stemX+'px'; p2.style.top=stemY+'px';
        const dyDown = (50+Math.random()*60);
        p2.style.setProperty('--dyDown', dyDown+'px');
        p2.style.animation='sugarDownStem 0.9s linear forwards';
        overlay.appendChild(p2);
        p2.addEventListener('animationend', ()=>{ if(!paused) p2.remove(); });
      }, 520);
    }
  }

  function manageParticles(on){
    if(!on){ if(particleTimer){ clearInterval(particleTimer); particleTimer=null; } return; }
    if(!particleTimer){
      particleTimer=setInterval(()=>{
        if(!productionActive()) return;
        const leaves=$$('.leaf');
        leaves.forEach(l=>{ spawnO2FromLeaf(l); spawnSugar(l); });
      }, PARTICLE_INTERVAL_MS);
    }
  }

  function updateMasses(dtY){
    
    if(productionActive()){
      plantKg = Math.min(END_PLANT, plantKg + IDEAL_GROWTH_PER_YEAR*dtY);
      leafGrowth = Math.min(1, leafGrowth + dtY/YEARS);
    }
  }

  function step(ts){
    if(!running){ requestAnimationFrame(step); return; }
    if(paused){ requestAnimationFrame(step); return; }
    if(rafLast===0) rafLast=ts;
    const dt=(ts-rafLast)/1000; rafLast=ts;
    const dtY=dt*YEARS_PER_SECOND;
    if(!finished){
      tYears += dtY;
      if(tYears >= YEARS){ tYears=YEARS; finished=true; running=false; enableResourceButtons(false);
        const endNote = document.getElementById('endNotice'); if(endNote) endNote.style.display='block';
        pauseBtn.disabled=true; startBtn.disabled=true; resetBtn.disabled=false;
        if(waterTimer) clearInterval(waterTimer);
        if(co2Timer) clearInterval(co2Timer);
        if(particleTimer) clearInterval(particleTimer);
      }
    }
    updateMasses(dtY);
    updateUI();
    requestAnimationFrame(step);
  }

  // Controls
  startBtn.addEventListener('click', ()=>{
    if(finished) return;
    running=true; paused=false; enableResourceButtons(true);
    startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false;
    leafGrowth=0.0; rafLast=0; updateUI();
  });
  pauseBtn.addEventListener('click', ()=>{
    if(finished) return; paused=!paused;
    pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Weiter' : '‚è∏Ô∏è Pause';
    setAnimationsPaused(paused);
    const pauseNote=document.getElementById('pauseNotice'); if(pauseNote) pauseNote.style.display = paused? 'block':'none';
    if(!paused){ rafLast=0; }
  });
resetBtn.addEventListener('click', ()=>{
    tYears=0; plantKg=START_PLANT; leafGrowth=0;
    onLight=onWater=onCO2=false; running=false; finished=false; paused=false;
    [btnLight,btnWater,btnCO2].forEach(b=>{ b.disabled=true; b.classList.remove('active'); const label=b.textContent.split(':')[0]; b.innerHTML=label+': <b>aus</b>'; });
    setLight(false);
    if(waterTimer) clearInterval(waterTimer);
    if(co2Timer) clearInterval(co2Timer);
    if(particleTimer) clearInterval(particleTimer);
    startBtn.disabled=false; pauseBtn.disabled=true; pauseBtn.textContent='‚è∏Ô∏è Pause';
    overlay.innerHTML=''; const endNote=document.getElementById('endNotice'); if(endNote) endNote.style.display='none'; const pauseNote=document.getElementById('pauseNotice'); if(pauseNote) pauseNote.style.display='none'; setAnimationsPaused(false); updateUI();
  });

  btnLight.addEventListener('click', ()=>{
    onLight=!onLight; setBtn(btnLight,onLight); setLight(onLight); manageParticles(productionActive());
  });
  btnWater.addEventListener('click', ()=>{
    onWater=!onWater; setBtn(btnWater,onWater);
    if(onWater && running && !paused && !finished){ startWater(); spawnWaterOnce(); } else { stopWater(); }
    manageParticles(productionActive());
  });
  btnCO2.addEventListener('click', ()=>{
    onCO2=!onCO2; setBtn(btnCO2,onCO2);
    if(onCO2 && running && !paused && !finished){ startCO2(); spawnCO2Once(); } else { stopCO2(); }
    manageParticles(productionActive());
  });

  window.addEventListener('resize', drawRays);
  // Init
  setLight(false); updateUI(); requestAnimationFrame(step);
})();
</script>
</body>
</html>
